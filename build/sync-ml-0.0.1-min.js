!function(a){var b={uuid:function(){var a,b,c="";for(a=0;32>a;a++)b=16*Math.random()|0,(8===a||12===a||16===a||20===a)&&(c+="-"),c+=(12===a?4:16===a?3&b|8:b).toString(16);return c},copy:function(a){return JSON.parse(JSON.stringify(a))}},c=function(a){this.sync_op=f.OP.NONE,this.sync_uuid=b.uuid(),this.userData=a},d=function(a){this.items=[],this.uuid="sync_"+a,this.init=function(){this.items=this.getItemsFromStore()},this.add=function(a,b){var d=new c(b);return d.sync_op=a,this.items.unshift(d),this.saveItemsToStore(),d},this.addBulk=function(a){for(var b=0;b<a.length;b++){var d=new c(a[b]);d.sync_op=f.OP.NONE,this.items.push(d)}this.saveItemsToStore()},this.remove=function(a){var b=this.getIndexById(a);if(b>=0){var c=this.items.splice(b,1);return this.saveItemsToStore(),c[0]}},this.update=function(a,b,c){var d=this.getIndexById(a);return d>=0?(this.items[d].userData=c,this.items[d].sync_op=b,this.saveItemsToStore(),this.items[d]):void 0},this.empty=function(){this.items=[],this.saveItemsToStore()},this.saveItemsToStore=function(){localStorage.setItem(this.uuid,JSON.stringify(this.items))},this.getItemsFromStore=function(){var a=localStorage.getItem(this.uuid);return"undefined"!=typeof a&&null!==a?JSON.parse(a):[]},this.getItems=function(){return b.copy(this.items)},this.getItemsExcluding=function(a){return jQuery(this.getItems()).filter(function(){return this.sync_op!==a})},this.getItemById=function(a){var b=this.getIndexById(a);return b>=0?this.items[b]:null},this.getIndexById=function(a){for(var b=0;b<this.items.length;b++)if(this.items[b].sync_uuid===a)return b;return-1}},e={connectCallbacks:[],disconnectCallbacks:[],init:function(b,c){"function"==typeof b&&this.connectCallbacks.push(b),"function"==typeof c&&this.disconnectCallbacks.push(c);var d=a.attachEvent||a.addEventListener,e=a.attachEvent?"ononline":"online",f=a.attachEvent?"onoffline":"offline";d(f,c),d(e,b)},isConnected:function(){a.navigator.onLine}},f=function(){this.apiHandler=null,this.init=function(a){if(this.apiHandler=a,"function"!=typeof a.add||"function"!=typeof a.update||"function"!=typeof a.remove||"function"!=typeof a.getData)throw"Api Handler doesn't implement the expected interface!";this.apiHandler.init()},this.promiseHandler=function(a,b){a.done(function(a){b(null,a)}),a.fail(function(a){b(a,null)})},this.send=function(a,b){var c=null;switch(a.sync_op){case f.OP.ADD:c=this.apiHandler.add(a.userData);break;case f.OP.UPDATE:c=this.apiHandler.update(a.userData);break;case f.OP.DELETE:c=this.apiHandler.remove(a.userData);break;default:console.error("syncer couldn't find an operation to perform on an item!")}null!==c&&this.promiseHandler(c,b)},this.get=function(a){this.promiseHandler(this.apiHandler.getData(),a)}};f.OP={NONE:0,ADD:1,UPDATE:2,DELETE:3};var g=function(a){var b=this,c=null,g=e,h=new d(a),i=new f,j=!1,k=function(){setTimeout(function(){b.sync(c)},3e3)},l=function(){};this.init=function(a,b){c="function"==typeof b?b:null;try{i.init(a)}catch(d){console.error(d),i=null}g.init(k,l),h.init(),this.sync(c)},this.syncItem=function(a,b){i.send(a,function(c,d){null===c&&(console.log(d),a.sync_op!==f.OP.DELETE?h.update(a.sync_uuid,f.OP.NONE,d):h.remove(a.sync_uuid)),b(c,{sync_id:a.sync_uuid,obj:a.userData})})},this.add=function(a,b){var c=h.add(f.OP.ADD,a);this.syncItem(c,b)},this.update=function(a,b,c){var d=h.getItemById(a);d=d.sync_op==f.OP.ADD?h.update(a,f.OP.ADD,b):h.update(a,f.OP.UPDATE,b),this.syncItem(d,c)},this.remove=function(a,b,c){var d=h.getItemById(a);return d.sync_op==f.OP.ADD||d.sync_op==f.OP.UPDATE?(d=h.remove(a),void c(null,{sync_id:d.sync_uuid,obj:d.userData})):(d=h.update(a,f.OP.DELETE,b),void this.syncItem(d,c))},this.sync=function(a){if(j)return void console.log("sync is already in progress!");console.log("sync started!"),j=!0;var b=h.getItemsExcluding(f.OP.NONE),c=[];if(b.length>0)for(var d=0;d<b.length;d++){var e=b[d];this.syncItem(e,function(){c.push(e),c.length===b.length&&m(a)})}else m(a)};var m=function(a){i.get(function(b,c){null==b&&(h.empty(),h.addBulk(c)),a(b,n()),j=!1,console.log("finished syncing")})},n=function(){for(var a=h.getItemsExcluding(f.OP.DELETE),b=[],c=0;c<a.length;c++){var d=a[c];b.push({sync_id:d.sync_uuid,obj:d.userData})}return b};this.get=function(a){a(n())},this.isSyncing=function(){return j}};a.SyncModule=g}(window);